                   {
   "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion": "1.0.0.0",
   "parameters": {
       "appRegistrationName": {
           "type": "string",
           "defaultValue": "Tuskira-Connector-App",
           "metadata": {
               "description": "Name of the Azure AD application registration"
           }
       }
   },
   "variables": {
       "subscriptionId": "[subscription().subscriptionId]",
       "tenantId": "[subscription().tenantId]",
       "identityName": "tuskira-appreg-identity"
   },
   "resources": [
       {
           "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
           "apiVersion": "2018-11-30",
           "name": "[variables('identityName')]",
           "location": "[resourceGroup().location]"
       },
       {
           "type": "Microsoft.Resources/deploymentScripts",
           "apiVersion": "2020-10-01",
           "name": "createAppRegistrationScript",
           "location": "[resourceGroup().location]",
           "kind": "AzureCLI",
           "dependsOn": [
               "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
           ],
           "identity": {
               "type": "UserAssigned",
               "userAssignedIdentities": {
                   "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]": {}
               }
           },
           "properties": {
               "azCliVersion": "2.51.0",
               "scriptContent": "set -e\n\necho 'Creating permissions.json...'\ncat > permissions.json << 'EOL'\n[\n  {\n    \"resourceAppId\": \"00000003-0000-0000-c000-000000000000\",\n    \"resourceAccess\": [\n      {\n        \"id\": \"7ab1d382-f21e-4acd-a863-ba3e13f7da61\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"bf394140-e372-4bf9-a898-299cfc7564e5\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"246dd0d5-5bd0-4def-940b-0421030a5b68\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"2f51be20-0bb4-4fed-bf7b-db946066c75e\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"df021288-bdef-4463-88db-98f22de89214\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"dd98c7f5-2d42-42d3-a0e4-633161547251\",\n        \"type\": \"Role\"\n      }\n    ]\n  },\n  {\n    \"resourceAppId\": \"fc780465-2017-40d4-a0c5-307022471b92\",\n    \"resourceAccess\": [\n      {\n        \"id\": \"41269fc5-d04d-4bfd-bce7-43a51cea049a\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"37f71c98-d198-41ae-964d-2c49aab74926\",\n        \"type\": \"Role\"\n      },\n      {\n        \"id\": \"ea8291d3-4b9a-44b5-bc3a-6cea3026dc79\",\n        \"type\": \"Role\"\n      }\n    ]\n  }\n]\nEOL\n\necho 'Creating app registration...'\nPERMISSIONS=$(cat permissions.json)\nAPP_REGISTRATION=$(az ad app create --display-name \"$appRegistrationName\" --required-resource-accesses \"$PERMISSIONS\")\n\necho \"App Registration created successfully\"\necho \"$APP_REGISTRATION\"\n\n# Set outputs\nAPP_ID=$(echo $APP_REGISTRATION | jq -r '.appId')\nAPP_OBJECT_ID=$(echo $APP_REGISTRATION | jq -r '.id')\n\necho \"{\\\"appRegistrationId\\\": \\\"$APP_ID\\\", \\\"appRegistrationObjectId\\\": \\\"$APP_OBJECT_ID\\\"}\" > $AZ_SCRIPTS_OUTPUT_PATH",
               "timeout": "PT30M",
               "cleanupPreference": "Always",
               "retentionInterval": "PT1H",
               "environmentVariables": [
                   {
                       "name": "appRegistrationName",
                       "value": "[parameters('appRegistrationName')]"
                   }
               ],
               "forceUpdateTag": "v1"
           }
       }
   ],
   "outputs": {
       "appRegistrationId": {
           "type": "string",
           "value": "[reference('createAppRegistrationScript').outputs.appRegistrationId]"
       },
       "appRegistrationObjectId": {
           "type": "string",
           "value": "[reference('createAppRegistrationScript').outputs.appRegistrationObjectId]"
       }
   }
}
